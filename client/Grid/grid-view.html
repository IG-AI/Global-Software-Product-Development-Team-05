<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>GSPD</title>
    <link rel="stylesheet" href="grid-view.css" type="text/css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  </head>
  <body>
    <h1>Global Software Product Development Team 05</h1>

    <div id="gridLayout"></div>

    <button id="orderButton" onClick="orderRobot()" disabled>Order to place package</button>
    <button id="refreshButton" onClick="renderGridLayout()">Manually refresh layout</button>
    <button id="streamButton" onClick="startStream()">Start stream</button>

    <br/>
    <br/>
    <iframe id="stream" type="text/html"
      width="320"
      height="193"
      frameborder="0">
    </iframe>

  <script>
    let gridDim = getGridDimension();
    let rows = gridDim[0];
    let columns = gridDim[1];

    let selectedGridPos;
    let streamOn = false;

    // Rendering the grid layout
    $(document).ready(function() {
      renderGridLayout();
    });

    function renderGridLayout() {
      let layoutArray = getCurrentGridLayout();
      var layoutIndexCounter = 0;

      // Reset the rendering of the grid layout
      var gridLayout = $('#gridLayout');
      gridLayout.replaceWith('<div id="gridLayout"></div>');
      gridLayout = $('#gridLayout');

      for (var row = 0; row < rows; row++) {
          for (var column = 0; column < columns; column++) {
          gridLayout.append(`
            <input onClick="selectGridPos(this.id)"
                   name="gridPos"
                   class="gridPos ${layoutArray[layoutIndexCounter]}"
                   type="button"
                   id="gridPos${row}${column}"
            />
            `);
          layoutIndexCounter += 1;
          }
        gridLayout.append('<br/>');
      }

      selectGridPos(selectedGridPos);
    }

    function selectGridPos(gridPosID) {
      if (!gridPosID) {
        return;
      }
      var selGridPos = document.getElementById(gridPosID);
      var alreadySelected = selGridPos.classList.contains("selectedGridPos");

      var allGridPos = document.getElementsByName('gridPos');
      for (var i = 0; i < allGridPos.length; i++) {
        allGridPos[i].classList.remove("selectedGridPos");
      }

      var orderButton = document.getElementById("orderButton");
      if(!alreadySelected){
        orderButton.disabled = false;
        selGridPos.classList.add("selectedGridPos");
        selectedGridPos = gridPosID;
      } else {
        orderButton.disabled = true;
        selectedGridPos = undefined;
      }
    }

    function startStream() {
      streamOn = !streamOn;
      var streamButton = document.getElementById("streamButton");
      var stream = document.getElementById("stream");

      if (streamOn) {
        streamButton.innerText = "Stop stream";

        stream.src = getStreamURL();
      } else {
        streamButton.innerText = "Start stream";
        stream.src = "";
      }
    }

    function orderRobot() {
      // TODO: Send API call to server to order changed drop off location
      console.log("Ordering robot to drop off package at", selectedGridPos);
    }

    function getStreamURL() {
      // TODO: Send API call to fetch real streaming URL
      return "http://www.youtube.com/embed/hZtC9oQoHfY";
    }

    function getGridDimension() {
      // TODO: Send API call to fetch real grid dimension of storage environment
      let rows = 3;
      let columns = 2;
      return [rows, columns];
    }

    function getCurrentGridLayout() {
      // TODO: Send API call to get info about the current layout of the grid
      return ['robot with right', 'empty', 'empty', 'empty', 'package', 'package'];
    }

    // Rerenders current grid layout every 5 seconds
    setInterval(function() {
      renderGridLayout();
    }, 5000);

  </script>
  </body>
</html>